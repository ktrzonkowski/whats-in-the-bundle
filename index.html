<!doctype html>
<html lang="en">
  <head>
    <title>WHAT'S IN THE BUNDLE</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/whats-in-the-bundle/style.css">
  </head>
  <body>
    <div id="filters" class="filters">
      Loading...
    </div>

    <hr>
    
    <div id="content" class="grid">
      Loading...
    </div>
    
    <script id="filterTemplate" type="text/x-dot-template">
      {{ for (var filter in it) { }}
        <div id="{{=filter}}" class="filter-group col">
          <label>{{=filter.toUpperCase()}}S</label>
          <select multiple="multiple">
            <option value="*">All</option>
            {{ for (var key in it[filter]) { }}
              <option value=".{{=filter}}-{{=key}}">{{=it[filter][key]}}</option>
            {{ } }}
          </select>
        </div>
      {{ } }}
    </script>
    
    <script id="gameTemplate" type="text/x-dot-template">
      {{~ it :game }}
        <div class="grid-item{{~ game.meta :meta }} {{=meta}}{{~}}">
          <a href="{{=game.url}}" target="_blank">
            <img class="lazy" src="/whats-in-the-bundle/loader.gif" data-src="{{=game.image}}" title="{{=game.name}}" alt="{{=game.name}}">
          </a>
          <div class="game-content">
            <a href="{{=game.url}}" target="_blank">{{=game.name}}</a>
            <p>{{=game.description}}</p>
          </div>
          <div class="game-meta">
            {{~ game.meta :meta }}
              <span>#{{=meta.replace(/^(tag|genre|platform)-/, '')}}</span>
            {{~}}
          </div>
          <div class="game-location">
            <div class="page">
              PAGE<br>
              {{=game.location.page}}
            </div>
            <div class="row">
              ROW<br>
              {{=game.location.row}}
            </div>
          </div>
        </div>
      {{~}}
    </script>
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dot/1.1.3/doT.min.js"></script>
    <script src="https://unpkg.com/isotope-layout@3/dist/isotope.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@16.1.0/dist/lazyload.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    
    <script>
      function loadTemplate (url, templateId, containerId) {
        return new Promise( (resolve, reject) => {
          fetch(url)
            .then( (response) => response.json() )
            .then( (data) => {
              var container = document.getElementById(containerId);
              var template = doT.template(document.getElementById(templateId).text);

              container.innerHTML = template(data);

              resolve();
            })
            .catch( (err) => {
              resolve();
            });
        });
      };

      var promises = [
	      loadTemplate('/whats-in-the-bundle/data/games.json', 'gameTemplate', 'content'),
        loadTemplate('/whats-in-the-bundle/data/meta.json', 'filterTemplate', 'filters')
      ];
      
      Promise.all(promises).then( () => {
        var $grid = $('.grid').isotope({
          itemSelector: '.grid-item',
          layoutMode: 'fitRows'
        });
	      
        new LazyLoad({
          elements_selector: ".lazy"
        });
        
        $('select').select2();
        
        $('#filters').on('change', 'select', function (e) {
          var selected = [];
          
          $("select").each(function () {
            console.log($(this).select2("val"));
          });
        });

        $('.filter-button-group').on( 'click', 'button', function () {
          $grid.isotope({ filter: this.getAttribute('data-filter') });
        });
      });
    </script>
  </body>
</html>
