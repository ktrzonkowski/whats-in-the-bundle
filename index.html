<html>
  <head>
    <title>WHAT'S IN THE BUNDLE</title>
    <link rel="stylesheet" href="/whats-in-the-bundle/style.css">
  </head>
  <body>
    <div id="filters" class="filters">
      Loading...
    </div>
	  
	  <hr>
    
    <div id="content" class="grid">
      Loading...
    </div>
    
    <script id="filterTemplate" type="text/x-dot-template">
      {{ for (var filter in it) { }}
        <div id="{{=filter}}" data-type="{{=filter}}" class="button-group filter-button-group">
          <strong>{{=filter.toUpperCase()}}S:</strong>
          <button data-filter="*">All</button>
          {{ for (var key in filter) { }}
            <button data-filter="{{=key}}">{{=filter[key]}}</button>
          {{ } }}
        </div>
      {{ } }}
    </script>
    
    <script id="gameTemplate" type="text/x-dot-template">
      {{~ it :game }}
        <div class="grid-item{{~ game.tags :tag }} tag-{{=tag.toLowerCase()}}{{~}}">
          <a href="{{=game.url}}" target="_blank">
            <img src="{{=game.image}}" title="{{=game.name}}" alt="{{=game.name}}">
          </a>
          <div class="game-content">
            <a href="{{=game.url}}" target="_blank">{{=game.name}}</a>
            <p>{{=game.description}}</p>
          </div>
          <div class="game-meta">
            {{~ game.meta :meta }}
              <span>#{{=meta.replace(/^(tag|genre|platform)-/, '')}}</span>
            {{~}}
          </div>
          <div class="game-location">
            <div class="page">
              PAGE<br>
              {{=game.location.page}}
            </div>
            <div class="row">
              ROW<br>
              {{=game.location.row}}
            </div>
          </div>
        </div>
      {{~}}
    </script>
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
			  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
			  crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dot/1.1.3/doT.min.js"></script>
    <script src="https://unpkg.com/isotope-layout@3/dist/isotope.pkgd.min.js"></script>
    
    <script>
      function loadTemplate (url, templateId, containerId) {
        return new Promise( (resolve, reject) => {
          fetch(url)
            .then( (response) => response.json() )
            .then( (data) => {
              var container = document.getElementById(containerId);
              var template = doT.template(document.getElementById(templateId).text);

              container.innerHTML = template(data);

              resolve();
            })
            .catch( (err) => {
              resolve();
            });
        });
      };

      var promises = [
	      loadTemplate('/whats-in-the-bundle/data/games.json', 'gameTemplate', 'content'),
        loadTemplate('/whats-in-the-bundle/data/meta.json', 'filterTemplate', 'filters')
      ];
      
      Promise.all(promises).then( () => {
        var $grid = $('.grid').isotope({
          itemSelector: '.grid-item',
          layoutMode: 'fitRows'
        });

        $('.filter-button-group').on( 'click', 'button', function () {
          var filterType = this.parentNode.getAttribute('data-type');
          var filterValue = this.getAttribute('data-filter');

          if (filterValue == "*") {
            $grid.isotope({ filter: "*" });
          }
          else {
            $grid.isotope({ filter: "." + filterType + "-" + filterValue });
          }
        });
      });
    </script>
  </body>
</html>
